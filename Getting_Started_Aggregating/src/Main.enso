from Standard.Base import all
from Standard.Table import all
from Standard.Database import all
from Standard.AWS import all
from Standard.Google_Api import all
import Standard.Visualization

## ![Image](eags.png)
   
   # Aggregations and Cross Tabs
   
   In this scenario, we want to look at calculating the number of accounts by type and by currency.
   
   ### 
   
   ## ğŸ—ï¸ **Objective 1:**Â  Lets read a single sheet in from Excel (Review from previous example):
   
   1ï¸âƒ£Â Â Â Â Â Â Â  The data has already been included in this workflow.
   
   2ï¸âƒ£Â Â Â Â Â Â Â  Add a new component after the ***Data.read*** component by either dragging from the output port (the bottom edge) of the `Data.read` component, or clicking the â• button on the component.
   
   3ï¸âƒ£Â Â Â Â Â Â Â  Add another new component after the ***Data.read*** component (See #2 above).
   
   - Choose the ***read*** component
   - Click on **query** then choose Sheet1
   
   ### 
   
   ## ğŸ—ï¸ **Objective 2:**Â  Aggregating by Account Type (Product Name):
   
   The first task is to add an aggregate component grouped by [product_name] and create a new column of data that summarizes the count of records for each Account Type.
   
   1ï¸âƒ£Â Â Â Â Â Â Â  Add a new component after the ***read*** component by either dragging from the output port (the bottom edge) of the ***read*** component, or clicking the â• button on the component.
   
   2ï¸âƒ£Â Â Â Â Â Â Â  Choose the ***aggregate*** component (Begin typing the term aggregate or sum) and hit enter or left-click on the ***aggregate*** component.
   
   - Click the group_by argument then choose [product_name]
   - Click on the [â•] symbol (to the right of the columns Â argument)
   - This will add the default of â€œCountâ€. Â *Note:Â  If you click on â€œCountâ€, you will see other options for aggregation.*
   - You can open the visualization (<>) and see the count of 1,026 Savings Accounts, as we saw in the prior example, along with counts for the 3 other products:
   ![Image](table1.png)
   
   .
   
   ## ğŸ—ï¸ **Objective 3:**Â  Sort/Order the aggregated counts in descending order of [Count]
   
   1ï¸âƒ£Â Â Â Â Â Â Â  Add an ***order_by*** component after the ***aggregate*** component.
   
   - Click on the [â•] symbol on the columns argument.
   - Click on the [product_name] and change it to Count (dropdown or typing).
   - Click on direction argument and choose Descending from the dropdown list. (Savings Account will now be at the bottom of the list as #3).
   
   .
   
   ## ğŸ—ï¸ **Objective 4:**Â  Create table of currencies by product names
   
   For each product name create a distinct count of accounts within each of the currency codes (from previous exercise we examined 3-digit currency codes with one (1) exception accouant).
   
   1ï¸âƒ£Â Â Â Â Â Â Â  Add a new ***cross_tab*** component after the ***read*** component.
   
   A cross tab allows us to create a column for each domain value for a given field (in this case [currency_code]).
   
   - Click on the group_by argument and choose [product_name].
   - Click on the names argument and choose [currency_code].
   - Click on the values argument and select â€œCount_Distinctâ€.
   - Click on the [â•] symbol and add the [account_id] field.
   
   When we complete this objective, youâ€™ll have 4 rows with 5 columns of data.
   
   .
   
   ## ğŸ—ï¸ **Objective 5:**Â  Create table of account statuses by currency_code
   
   For each currency code create a distinct count of accounts within each of the account statuses.Â  In this data, youâ€™ll find that there is at least one account status that has a â€˜dirtyâ€™ value.Â  For extra credit, you can cleanse that status (See next Objective).
   
   1ï¸âƒ£Â Â Â Â Â Â Â  Add a new ***cross_tab*** component after the ***read*** component.
   
   Create the configuration properly and you will see the four (4) currency values and the three (3) account statuses.Â  Letâ€™s guide you through the extra credit assignment.
   
   ğŸ—ï¸ **Objective 5 Extra Credit:**Â  Create table of account statuses by a cleansed currency code field.Â  Youâ€™ll want to convert any â€œCâ€ statuses to â€œClosedâ€ prior to the ***cross_tab*** component.Â  You can accomplish this by:
   
   1ï¸âƒ£Â Â Â Â Â Â  Add a new ***set*** component (set can be used to update values in an existing field or to add new fields to the incoming data) after the ***read*** component.
   
   2ï¸âƒ£Â Â Â Â Â Â Â  Configure the ***set*** component to update â€œCâ€ values to â€œClosedâ€
   
   ![Image](set.gif)
   
   - Click on the value argument and choose <Simple Expression>.
   - Click on the input argument and choose the [account_status] column.
   - Click on the operation argument and choose the â€œifâ€ operation.
   - Click on the input argument and choose the [account_status] column.
   - Click on the condition argument and choose the â€œEqualsâ€ option.
   - Click on the true_value argument and choose the <Text Value> option.
   - Type the letter â€œCâ€ between the quote marks.
   - Click on the false_value argument and choose the <Text Value> option.
   - Type the word â€œClosedâ€ between the quote marks.
   - Click on the double-quotes (following the word as) and type the column name â€œaccount_statusâ€ (default will be to add a â€˜copyâ€™ to the end of the data)
   
   3ï¸âƒ£Â Â Â Â Â Â  Either reconnect the existing ***cross_tab*** component or create a new ***cross_tab*** component to this cleansed data.
   
   ## 
   
   # **Exercise 3: Create a cross tab grouped by currency code with counts by each account status.**
   
   - Additional challenge to normalise the C into Closed account (use set).
   Your answer should look like the following:
   ![image](answer_table.png)
main =
    operator1 = "Aggregration and Pivoting Data"
    any1 = Data.read enso_project.data/'sample_bank_data.xlsx'



#### METADATA ####
[[{"index":{"value":5605},"size":{"value":32}},"74c61235-eefb-415c-a579-554292e963b5"],[{"index":{"value":5649},"size":{"value":9}},"ba17bd32-db36-4d49-8912-90a3e5023f4b"],[{"index":{"value":5649},"size":{"value":51}},"0a32a7f0-79d8-43b8-8b45-1944a375cceb"]]
{"ide":{"node":{"74c61235-eefb-415c-a579-554292e963b5":{"position":{"vector":[-534,1116]}},"0a32a7f0-79d8-43b8-8b45-1944a375cceb":{"position":{"vector":[-645,1025]}},"ba17bd32-db36-4d49-8912-90a3e5023f4b":{"position":{"vector":[-645,1025]}}},"import":{}}}